<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galgame: ç”œç‚¹è‰²çš„æ‹çˆ± (å®Œæ•´ç‰ˆ)</title>
    <style>
        /* --- æ ·å¼è¡¨ --- */
        :root { --pink: #FFC6D0; --blue: #AEEEEE; --text: #5c5c5c; }
        body {
            margin: 0; background: #fff0f5; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            font-family: "Microsoft YaHei", sans-serif; user-select: none;
        }

        /* æ¸¸æˆä¸»èˆå° */
        #game-stage {
            width: 900px; height: 640px; background: #fff;
            position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1);
            border-radius: 15px; overflow: hidden; border: 8px solid #fff;
        }

        /* 1. èƒŒæ™¯å±‚ */
        #bg-layer {
            position: absolute; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: opacity 0.5s;
        }
        .bg-school { background-image: linear-gradient(to bottom, #87CEFA, #E0FFFF); } /* é»˜è®¤èƒŒæ™¯è‰²ï¼Œå¯æ¢å›¾ */
        .bg-sunset { background-image: linear-gradient(to bottom, #FFDAB9, #FFFACD); }
        .bg-night { background-image: linear-gradient(to bottom, #2c3e50, #4ca1af); }

        /* 2. ç«‹ç»˜å±‚ (æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨imgæ ‡ç­¾) */
        #char-layer {
            position: absolute; bottom: 0; left: 50%;
            transform: translateX(-50%); height: 90%;
            pointer-events: none; transition: 0.3s;
            display: none; /* é»˜è®¤éšè— */
        }
        #char-img {
            height: 100%; width: auto;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
        }

        /* 3. UIå±‚ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #dialogue-box {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            height: 180px; background: rgba(255, 255, 255, 0.95);
            border: 4px solid var(--pink); border-radius: 20px;
            padding: 25px; box-sizing: border-box;
        }
        #name-tag {
            font-size: 22px; font-weight: bold; color: #ff8fab;
            background: white; padding: 4px 20px; border-radius: 15px;
            border: 2px solid var(--blue); display: inline-block; margin-bottom: 10px;
        }
        #text-content { font-size: 20px; line-height: 1.6; color: var(--text); }
        
        /* çŠ¶æ€æ  */
        #status-bar {
            position: absolute; top: 20px; left: 20px;
            display: flex; gap: 15px;
        }
        .tag { background: white; padding: 5px 15px; border-radius: 20px; border: 2px solid var(--pink); color: var(--text); font-weight: bold; font-size: 14px;}

        /* 4. é€‰é¡¹å±‚ */
        #option-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px);
            z-index: 50; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .opt-btn {
            width: 60%; padding: 18px; margin: 10px;
            background: white; border: 3px solid var(--blue); border-radius: 40px;
            font-size: 20px; color: var(--text); font-weight: bold; cursor: pointer;
            transition: 0.2s; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .opt-btn:hover { background: var(--blue); color: white; transform: scale(1.05); }

        /* 5. ç‚¹å‡»é®ç½© */
        #click-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 40; cursor: pointer;
        }

    </style>
</head>
<body>

<div id="game-stage">
    <div id="bg-layer" class="bg-school"></div>

    <div id="char-layer">
        <img id="char-img" src="yui_normal.png" onerror="this.src='https://placehold.co/400x800/pink/white?text=Yui+Normal'">
    </div>

    <div id="ui-layer">
        <div id="status-bar">
            <div class="tag">ğŸ“… Day: <span id="day-disp">1</span></div>
            <div class="tag">ğŸ’– å¥½æ„Ÿåº¦: <span id="love-disp">0</span></div>
        </div>
        <div id="dialogue-box">
            <div id="name-tag">ç³»ç»Ÿ</div>
            <div id="text-content">ç‚¹å‡»å±å¹•å¼€å§‹...</div>
        </div>
    </div>

    <div id="click-mask" onclick="handleClick()"></div>

    <div id="option-layer"></div>
</div>

<script>
    /* --- 1. æ¸¸æˆå‰§æœ¬æ•°æ® (Database) --- */
    const script = {
        // === ç¬¬ä¸€ç« ï¼šåˆé‡ ===
        "start": {
            day: 1, bg: "bg-school", char: null, name: "æˆ‘",
            text: "é«˜ä¸­äºŒå¹´çº§çš„æ˜¥å¤©ã€‚æˆ‘åœ¨æ—§æ ¡èˆåçš„æ¨±èŠ±æ ‘ä¸‹ï¼Œæ¡åˆ°äº†ä¸€æœ¬é—è½çš„ç´ ææœ¬ã€‚",
            next: "meet_1"
        },
        "meet_1": {
            bg: "bg-school", char: "normal", name: "???",
            text: "é‚£ã€é‚£ä¸ªï¼è¯·é—®...ä½ æœ‰çœ‹åˆ°ä¸€æœ¬è“è‰²çš„æœ¬å­å—ï¼Ÿ",
            next: "meet_2"
        },
        "meet_2": {
            bg: "bg-school", char: "normal", name: "æˆ‘",
            text: "è½¬è¿‡èº«ï¼Œä¸€ä¸ªæ°”å–˜ååçš„å¥³ç”Ÿæ­£çœ‹ç€æˆ‘ã€‚æ˜¯éš”å£ç­çš„ç»“è¡£åŒå­¦ã€‚",
            next: "choice_1"
        },
        "choice_1": {
            type: "choice",
            options: [
                { text: "ç›´æ¥è¿˜ç»™å¥¹ (æ™®é€š)", target: "r_normal" },
                { text: "ç¬‘ç€é—®ï¼šç”»å¾—å¾ˆå¯çˆ±å“¦ (å¿ƒåŠ¨)", target: "r_flirt" }
            ]
        },
        "r_normal": {
            bg: "bg-school", char: "normal", name: "ç»“è¡£",
            text: "è°¢ã€è°¢è°¢ä½ ï¼è¿™å¯¹æˆ‘çœŸçš„å¾ˆé‡è¦ã€‚",
            action: g => g.love += 5,
            next: "jump_to_mid" // æ¼”ç¤ºç”¨ï¼Œç›´æ¥è·³åˆ°ä¸­æœŸ
        },
        "r_flirt": {
            bg: "bg-school", char: "love", // ä½¿ç”¨å®³ç¾ç«‹ç»˜
            name: "ç»“è¡£",
            text: "è¯¶ï¼Ÿï¼ä½ ã€ä½ éƒ½çœ‹è¿‡äº†å—ï¼Ÿå‘œ...å¥½å®³ç¾...",
            action: g => g.love += 15,
            next: "jump_to_mid"
        },

        // === ä¸­æœŸè½¬åœº ===
        "jump_to_mid": {
            bg: "bg-night", char: null, name: "ç³»ç»Ÿ",
            text: "ã€æ—¶å…‰é£é€...ã€‘ ä½ ä»¬çš„å…³ç³»é€æ¸æ‹‰è¿‘ï¼Œç»å¸¸ä¸€èµ·åœ¨å¤©å°åƒåˆé¥­ã€‚",
            next: "conflict_start"
        },

        // === ç¬¬äº”ç« ï¼šå°å†²çª/è¯¯ä¼š ===
        "conflict_start": {
            day: 5, bg: "bg-sunset", char: "normal", name: "ç»“è¡£",
            text: "å‘ï¼Œå¬è¯´...æ˜¨å¤©æ”¾å­¦ä½ å’Œæ ¡èŠ±ä¸€èµ·èµ°çš„ï¼Ÿ",
            next: "conflict_choice"
        },
        "conflict_choice": {
            type: "choice",
            options: [
                { text: "åªæ˜¯é¡ºè·¯ç¢°åˆ°çš„ (è§£é‡Š)", target: "c_explain" },
                { text: "æ€ä¹ˆï¼Œåƒé†‹äº†å—ï¼Ÿ (è°ƒä¾ƒ)", target: "c_tease" }
            ]
        },
        "c_explain": {
            bg: "bg-sunset", char: "normal", name: "ç»“è¡£",
            text: "æ˜¯ã€æ˜¯è¿™æ ·å•Š...æˆ‘ç›¸ä¿¡ä½ ã€‚",
            action: g => g.love += 10,
            next: "jump_to_end"
        },
        "c_tease": {
            bg: "bg-sunset", char: "love", name: "ç»“è¡£",
            text: "ç¬¨ã€ç¬¨è›‹ï¼è°åƒé†‹äº†ï¼...è™½ç„¶...æ˜¯æœ‰ä¸€ç‚¹ç‚¹ä¸å¼€å¿ƒã€‚",
            action: g => g.love += 25, // é«˜é£é™©é«˜å›æŠ¥
            next: "jump_to_end"
        },

        // === ç»ˆç« åˆ¤å®š ===
        "jump_to_end": {
            bg: "bg-night", char: null, name: "ç³»ç»Ÿ",
            text: "ã€æ•°å‘¨åçš„çƒŸç«å¤§ä¼šã€‘ å‘½è¿çš„æ—¶åˆ»åˆ°æ¥äº†...",
            next: "check_ending" // è·³è½¬åˆ°é€»è¾‘åˆ¤å®šèŠ‚ç‚¹
        },
        
        // === é€»è¾‘åˆ¤å®šèŠ‚ç‚¹ (ä¸æ˜¾ç¤ºæ–‡æœ¬ï¼Œåªè´Ÿè´£è·³è½¬) ===
        "check_ending": {
            type: "check",
            condition: (g) => g.love >= 30, // åˆ¤å®šé—¨æ§›
            trueTarget: "end_true",    // æˆåŠŸè·³è½¬
            falseTarget: "end_normal"  // å¤±è´¥è·³è½¬
        },

        // === æ™®é€šç»“å±€ ===
        "end_normal": {
            day: 10, bg: "bg-night", char: "normal", name: "ç»“è¡£",
            text: "ä»Šæ™šçš„çƒŸèŠ±çœŸç¾å‘¢ã€‚è°¢è°¢ä½ é™ªæˆ‘ï¼Œæ˜å¤©å­¦æ ¡è§å§ï¼",
            next: "fin_normal"
        },
        "fin_normal": {
            bg: "bg-night", char: null, name: "ç»“å±€",
            text: "ã€Normal Endï¼šå¥½æœ‹å‹ã€‘ (å¥½æ„Ÿåº¦ä¸è¶³ï¼Œæœªèƒ½è§¦å‘å‘Šç™½)",
            next: null
        },

        // === çœŸç»“å±€ (æ»¡å¥½æ„Ÿè§¦å‘) ===
        "end_true": {
            day: 10, bg: "bg-night", char: "love", name: "ç»“è¡£",
            text: "ç­‰ç­‰ï¼...æˆ‘ã€æˆ‘æœ‰è¯æƒ³å¯¹ä½ è¯´ï¼",
            next: "confession_1"
        },
        "confession_1": {
            bg: "bg-night", char: "love", name: "ç»“è¡£",
            text: "è™½ç„¶ä¸€å¼€å§‹åªæ˜¯å¶ç„¶...ä½†ç°åœ¨ï¼Œæˆ‘æƒ³ä¸€ç›´å’Œä½ åœ¨ä¸€èµ·ï¼",
            next: "confession_2"
        },
        "confession_2": {
            bg: "bg-night", char: "love", name: "ç»“è¡£",
            text: "ï¼ˆå¥¹ç´§ç´§æŠ“ä½äº†ä½ çš„è¡£è¢–ï¼Œè„¸çº¢å¾—åƒç†Ÿé€çš„è‹¹æœï¼‰...å–œæ¬¢ä½ ã€‚",
            next: "fin_true"
        },
        "fin_true": {
            bg: "bg-night", char: "love", name: "ç»“å±€",
            text: "âœ¨ã€Happy Endï¼šæ¨±èŠ±è‰²çš„èª“è¨€ã€‘âœ¨ æ­å–œè¾¾æˆå®Œç¾ç»“å±€ï¼",
            next: null
        }
    };

    /* --- 2. å¼•æ“é€»è¾‘ --- */
    let gameState = { id: "start", love: 0, day: 1, typing: false };
    const els = {
        bg: document.getElementById('bg-layer'),
        charLayer: document.getElementById('char-layer'),
        charImg: document.getElementById('char-img'),
        name: document.getElementById('name-tag'),
        text: document.getElementById('text-content'),
        opts: document.getElementById('option-layer'),
        mask: document.getElementById('click-mask'),
        day: document.getElementById('day-disp'),
        love: document.getElementById('love-disp')
    };
    let timer;

    // åˆå§‹åŒ–
    render("start");

    function handleClick() {
        if (gameState.typing) {
            finishType(script[gameState.id].text);
            return;
        }
        let scene = script[gameState.id];
        
        // å¦‚æœæ˜¯é€»è¾‘åˆ¤å®šèŠ‚ç‚¹ï¼Œè‡ªåŠ¨æ‰§è¡Œ
        if (scene.type === "check") return; 

        if (scene.type === "choice" || !scene.next) return;
        render(scene.next);
    }

    function render(id) {
        gameState.id = id;
        let scene = script[id];

        // 1. å¤„ç†å¥½æ„Ÿåº¦/å¤©æ•°æ›´æ–°
        if (scene.action) scene.action(gameState);
        if (scene.day) gameState.day = scene.day;
        updateUI();

        // 2. ç‰¹æ®ŠèŠ‚ç‚¹ï¼šæ¡ä»¶åˆ¤å®š (Check)
        if (scene.type === "check") {
            let nextId = scene.condition(gameState) ? scene.trueTarget : scene.falseTarget;
            render(nextId); // é€’å½’è°ƒç”¨ï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€å¹•
            return;
        }

        // 3. åœºæ™¯æ¸²æŸ“
        if (scene.bg) els.bg.className = scene.bg;
        
        // ç«‹ç»˜åˆ‡æ¢é€»è¾‘
        if (scene.char) {
            els.charLayer.style.display = "block";
            // è¿™é‡Œå®ç°äº†å›¾ç‰‡åˆ‡æ¢ï¼šå¦‚æœæ˜¯ "love" å°±ç”¨ yui_love.png
            let imgSrc = scene.char === "love" ? "yui_love.png" : "yui_normal.png";
            // è¿˜æœ‰é˜²å‘†è®¾è®¡ï¼šå¦‚æœæ˜¯å ä½ç¬¦ï¼Œå°±åˆ‡æ¢å ä½ç¬¦çš„é¢œè‰²
            let placeholdSrc = scene.char === "love" 
                ? "https://placehold.co/400x800/ff99aa/white?text=Yui+Shy"
                : "https://placehold.co/400x800/AEEEEE/white?text=Yui+Normal";
            
            // å°è¯•åŠ è½½æœ¬åœ°å›¾ç‰‡ï¼Œå¦‚æœå¤±è´¥ï¼ˆonerrorï¼‰ä¼šè‡ªåŠ¨åŠ è½½ä¸Šé¢çš„ placeholdSrc
            els.charImg.src = imgSrc;
            els.charImg.onerror = function() { this.src = placeholdSrc; };
            
        } else {
            els.charLayer.style.display = "none";
        }

        // 4. æ–‡æœ¬ä¸é€‰é¡¹
        if (scene.type === "choice") {
            els.opts.innerHTML = "";
            els.opts.style.display = "flex";
            els.mask.style.display = "none"; // é€‰é¡¹æ—¶ç¦ç”¨èƒŒæ™¯ç‚¹å‡»
            scene.options.forEach(o => {
                let btn = document.createElement("div");
                btn.className = "opt-btn";
                btn.innerText = o.text;
                btn.onclick = () => {
                    els.mask.style.display = "block";
                    render(o.target);
                };
                els.opts.appendChild(btn);
            });
        } else {
            els.opts.style.display = "none";
            els.name.innerText = scene.name;
            typeText(scene.text);
        }
    }

    function updateUI() {
        els.love.innerText = gameState.love;
        els.day.innerText = gameState.day;
        // ç®€å•çš„å¥½æ„Ÿåº¦é¢œè‰²å˜åŒ–
        els.love.style.color = gameState.love > 20 ? "red" : "#ff8fab";
    }

    function typeText(str) {
        gameState.typing = true;
        els.text.innerHTML = "";
        let i = 0;
        clearInterval(timer);
        timer = setInterval(() => {
            if (i < str.length) {
                els.text.innerHTML += str.charAt(i);
                i++;
            } else {
                finishType(str);
            }
        }, 30);
    }

    function finishType(str) {
        clearInterval(timer);
        els.text.innerHTML = str;
        gameState.typing = false;
    }

</script>
</body>
</html>